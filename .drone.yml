kind: pipline
name: Winsper-Server

steps:
- name: test
  image: gusabary/cn-maven
  volumes:
  - name: dependency
    path: /root/.m2
# - name: configuration
#   path: /drone/src/back-end/src/main/resources/application.yml
  commands:
  - mvn clean
  - mvn package -Dmaven.test.skip=true
  - echo "test and package server completed"

- name: upload
  image: appleboy/drone-scp
  settings:
    host: 10.0.0.98
    username: root
    key: 
      from_secret: private_key
    rm: true
    target: /root/Winsper/drone-tmp
    source:
    - target/winsper-server-0.0.1-SNAPSHOT.jar
    - Dockerfile

- name: deploy
  image: appleboy/drone-ssh
  settings:
    host: 10.0.0.98
    username: root
    key: 
      from_secret: private_key
    script:
    - cd /root/Winsper/drone-tmp/target
    - cp ../Dockerfile .
    - docker build -t gusabary/winsper-eureka .
    - docker login
    - docker push gusabary/winsper-eureka
    - cd /root/Winsper/Winsper
    - kubectl delete deploy/winsper-eureka
    - kubectl apply -f eureka-deployment.yml

volumes:
- name: dependency
  host:
    path: /root/.m2